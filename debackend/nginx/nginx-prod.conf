# todo: задача, нужно попытаться получить порты и прочие штуки из .enc файла, пока что этого сделать не удалось - захардкодил здесь
worker_processes  1;

events {
    worker_connections  1024;
}
http {
    # Укажите доверенный IP-адрес вашего прокси
    set_real_ip_from 135.181.255.138;
    # Укажите, что реальный IP-адрес клиента находится в заголовке X-Forwarded-For
    real_ip_header X-Forwarded-For;

    # Определяем зону для загрузок страниц
    limit_req_zone $binary_remote_addr zone=zone_main:10m rate=5r/s;

    # Определяем зону для ограничений на статические файлы
    limit_req_zone $binary_remote_addr zone=zone_staticFiles:10m rate=100r/s;

    server {
        listen 80;
        listen [::]:80;

        server_name dessly.net steam.dessly.net;
        server_tokens off;

        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        location / {
            return 301 https://$host$request_uri;
        }
    }

    # HTTPS dessly.net
    server {
        listen 443 default_server ssl http2;
        listen [::]:443 ssl http2;

        server_name dessly.net steam.dessly.net;

        ssl_certificate /etc/nginx/ssl/live/dessly.net-0003/fullchain.pem;
        ssl_certificate_key /etc/nginx/ssl/live/dessly.net-0003/privkey.pem;

        proxy_intercept_errors on;
        error_page 403 /ERROR403.html;

        # graphql не работает без этого, т.е. даже запросы с фронт контейнера на бек контейнер не идут,
        # хотя это внутри сети docker.compose, вот так он принуждает открыть доступ снаружи к graphql
        # Это вообще костыль, зачем сюда его выносить не понятно, но по другому контейнеры друг с другом не общаются!!!
        location /graphql {
            limit_req zone=zone_main burst=50 nodelay;

            proxy_pass http://deshopbackend:8081/graphql;

            # ---------- ---------- ---------- Subscriptions для GQL не работают без этого блока кода ---------- ---------- ----------
            # Настройки для WebSocket
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # Установите таймауты для поддержания долгих соединений
            proxy_read_timeout 86400;
            proxy_send_timeout 86400;
            # ---------- ---------- ---------- Subscriptions для GQL не работают без этого блока кода ---------- ---------- ----------

            # Разрешаем CORS
            if ($http_origin ~* '^https?://(dessly\.net|steam\.dessly\.net|admin\.dessly\.net)$') {
                add_header 'Access-Control-Allow-Origin' "$http_origin" always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Accept, Origin, X-Requested-With' always;
                add_header 'Access-Control-Allow-Credentials' 'true' always;
            }

            # Обработка OPTIONS-запросов
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' "$http_origin" always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Accept, Origin, X-Requested-With' always;
                add_header 'Access-Control-Allow-Credentials' 'true' always;
                return 204;
            }
        }

        # Redirect Next.js assets to Next.js.
        location ~ ^/(_next|__next) {
            limit_req zone=zone_staticFiles burst=1000 nodelay;

            proxy_pass http://deshopfrontend:3000;
        }

        # Redirect all other pages, API routes and assets to Next.js.
        location / {
            limit_req zone=zone_main burst=50 nodelay;

            proxy_set_header Host $host;
            proxy_pass http://deshopfrontend:3000$request_uri;
        }

        # Код от GPT решил задачу с прокидываением через /api/ запросов на бек
        # todo: нужно сделать так, что бы через api и graphql ходил, тогда у нас будет одна точка входа на бек, а пока что их 2
        #
        # proxy_pass http://deshopbackend:8081/; — Обратите внимание на завершающий /. Это означает, что /api/ на исходном сервере будет заменено на / на сервере назначения.
        #
        # rewrite ^/api(/.*)$ $1 break; — Эта строка удаляет префикс /api из пути запроса перед его отправкой на проксируемый сервер, чтобы избежать дублирования.
        #
        # Теперь запрос на http://localhost:8081/api/notification_payplych будет проксирован как http://deshopbackend:8081/notification_payplych, что решит проблему с дублированием.
        location /api/ {
            limit_req zone=zone_main burst=50 nodelay;

            proxy_pass http://deshopbackend:8081/;
            rewrite ^/api(/.*)$ $1 break;
        }

        # ↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓  private ↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓
        location /pgadmin {
            proxy_set_header X-Script-Name /pgadmin;
            proxy_set_header Host $host;
            proxy_pass http://pg_admin_deshopbackend;
            proxy_redirect off;
        }

        location /database {
            allow 65.108.218.57;
            deny all;

            proxy_pass http://pg_deshopbackend:5432;
        }
    }
}
